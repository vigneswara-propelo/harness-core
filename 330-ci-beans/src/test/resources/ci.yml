pipeline:
  identifier: cipipeline
  name: Integration Pipeline
  description: sample pipeline used for testing
  stages:
  - stage:
      identifier: masterBuildUpload
      type: ci
      spec:
        description: This stage is run hourly to build binaries from master and upload
        infrastructure:
          type: kubernetes-direct
          spec:
            connectorRef: MyKubeCluster1
            namespace: ShoppingCart
        gitConnector:
          identifier: gitRepo
          type: git
          spec:
            authScheme:
              type: ssh
              sshKey: gitSsh
            repo: master
        container:
          identifier: jenkinsSlaveImage
          connector: "npquotecenter"
          imagePath: "us.gcr.io/platform-205701/jenkins-slave-portal-oracle-8u191:12" #if version
        customVariables: #users can specify both in the pipeline & stage level. these vars are available as env vars
          - name: internalPath
            type: text
            value: "{input}"
          - name: runTimeVal #will get a value in runtime to be used in a following stage -how?
            type: secret
            value: account.secret
        execution:
          steps:
            - step:
                identifier: gitClone
                type: gitClone
                spec:
                  gitConnector: gitGlobal
                  path: portal
                  branch: master
            - parallel:
                - step:
                    identifier: runLint
                    type: run
                    spec:
                      retry: 2
                      timeout: 30
                      command: ./run lint
                - step:
                    identifier: runAllUnitTests
                    type: run
                    spec:
                      retry: 2
                      timeout: 30
                      command: mvn -U clean package -Dbuild.number=${BUILD_NUMBER} -DgitBranch=master -DforkMode=perthread -DthreadCount=3 -DargLine="-Xmx2048m"
                      reports:
                        - type: junit
                          spec:
                            paths:
                              - rspec.xml
                              - reports.xml
                - step:
                    identifier: runUnitTestsIntelligently
                    type: testIntelligence
                    spec:
                      retry: 2
                      timeout: 30
                      goals: echo "Running test"
                      buildTool: maven
                      language: java
            - step:
                identifier: generateReport
                type: run
                spec:
                  timeout: 30
                  retry: 2
                  command: ./ci/generate_report.sh
            - step:
                identifier: buildMaster
                type: run
                spec:
                  retry: 2
                  timeout: 75
                  command: mvn clean install
            - step:
                identifier: uploadArtifact
                type: publishArtifacts
                spec:
                  publishArtifacts:
                    - dockerFile: Dockerfile
                      context: workspace
                      image: ui
                      tag: 1.0.0
                      buildArguments:
                        - key : key1
                          value: value1
                        - key: key2
                          value: value2
                      gcr:
                        type: GCR
                        location: eu.gcr.io/harness/ui:latest
                        connectorRef: myDockerRepoConnector
            - step:
                identifier: minio
                type: plugin
                spec:
                  image: "plugins/s3"
                  settings:
                    secret_key: foo
                    access_key: bar